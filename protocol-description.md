# Настоящий документ описывает протокол взаимодействия между головным устройством (далее - MASTER) и модулем расширения (далее - MODULE) от внешних разработчиков
***
## Соглашение о терминах
* ***Команда*** - инструкция для выполнения каких-либо действий;
* ***Ответ*** - отклик устройства, получившего определённую команду;
* ***Параметр*** - характеристика, определяющая поведение какого-либо объекта (например - датчика), которую можно прочитать и изменить;
* ***Данные*** - результат измерения датчика - физические единицы измеренной величины, представленные в виде числа с плавающей точкой;
* ***Датчик*** - сущность, преобразующая определённые внешние воздействия в значения физических величин в виде чисел с плавающей точкой;
* ***Канал датчика*** - часть датчика, отвечающая за измерение конкретного физического воздействия (например, ускорение по оси Х, ускорение по оси У и т.д.). У одного датчика может быть от одного до N каналов;
* ***MASTER*** - ведущее устройство, обеспечивающее взаимодействие с приложением по Bluetooth и считывание данных с датчиков, а также фильтрацию и калибровку данных;
* ***MODULE*** - ведомое устройство, обеспечивающее работу с реальным физическим датчиком (датчиками) и нормирование "сырых" величин к виду данных.
***
### Примечание
В данном тексте в примерах команд одинарные кавычки - это непечатаемые символы, означающие строку. Реальным ASCII-символом являются только двойные кавычки. Пример: 'string with values = "something" and "something else"' - это строка, которая в ASCII выглядит так - ***string with value = "something" and "something else"***
***
## Характеристики системы \<MASTER-MODULE\>
* количество физических датчиков в рамках одного MODULE - от 1 и выше;
* количество каналов измерения в рамках одного датчика - от 1 и выше (например, акселерометер - трёхканальный);
* физический интерфейс для подключения MODULE к MASTER - UART в дуплексном режиме, скорость 115200, 8n1;
* управление потоком UART: на стороне MASTER - RTS, на стороне MODULE - CTS;
* дополнительное управление от MASTER к MODULE - сигнал RESET для сброса MODULE;
* протокол команд/ответов - АТ;
* протокол данных - строковый протокол плоттера.
***
## Про датчики с точки зрения MODULE
Все датчики с точки зрения MODULE должны быть представлены в виде ассоциированных пар \[\<index\> : \<uuid\>\] для однозначной идентификации датчика по индексу. Индекс предствляет собой целочисленное значение от 0 и выше. Этот словарь вычитывается MASTER-ом в начале работы и все дальнейшие обращения к датчикам происходят по индексу для уменьшения количества траффика через интерфейс.
***
## Протокол команд/ответов
MASTER отправляет в сторону MODULE команды и получает от MODULE ответы в формате протокола АТ. Протокол AT предполагает связь "точка-точка", одно устройство формирует запросы (ведущий, в нашем случае MASTER), второе устройство отвечает (ведомый, в нашем случае MODULE). Рассмотрим более подробно синтаксис АТ-команд:  
  
### Команды  
АТ-команда представляет собой строку ASCII-символов в формате  
> 'AT\<COMMAND\>\<SUFFIX\>\<PARAMS\>\r\n'  
  
В начале всегда идёт префикс 'AT', затем команда, далее - суффикс, определяющий тип команды, после - параметры, в самом конце - завершающая последовательность '\r\n'.
  
**ВНИМАНИЕ!** - далее, для упрощения, завершающая последовательность '\r\n' не показывается. Но она есть)  
  
В широком смысле, AT-команды можно разделить на два формата: **Basic Commands** и **Extended Commands**.
* **Basic Commands** - эти команды не начинаются с '+'. Пример: 'ATCFG'. 
* **Extended commands** - эти команды начинаются с '+'. Пример: 'AT+CFG'.
В настоящем протоколе все команды в формате Extended для упрощения парсинга.  
  
Кроме того, все АТ-команды делятся на 4 типа. Тип определяется суффиксом, согласно следующей таблице:

|Type      |Suffix | Назначение                               |
|----------|:-----:|------------------------------------------|
|Test      |=?     |Проверка поддержки ведомым данной команды |
|Read      |?      |Получение от ведомого параметров          |
|Set       |=      |Установка на ведомом параметров           |
|Execution |       |Запуск определённого действия             |
  
* **Test Commands** - эти команды позволяют узнать, поддерживает ли ведомый данную команду или нет. Синтаксис: 'AT\<COMMAND\>=?'. Пример: 'AT+CFG=?'.
* **Read Commands** - эти команды служат для получения параметров от ведомого. Синтаксис: 'AT\<COMMAND\>?'. Пример: 'AT+CFG?'.
* **Write Commands** - эти команды служат для установки параметров ведомого. Синтаксис: 'AT\<COMMAND\>=\<par1\>,\<par2\>,...,\<parN\>'. Пример: 'AT+CFG=1,"ON",9'.
* **Execution Commands** - эти команды запускают на ведомом определённые действия. Синтаксис: 'AT\<COMMAND\>'. Пример: 'AT+STRT'.  
Особняком стоит специализированная пустая команда, состоящая только из префикса 'AT'. Формально - это пустая команда с типом EXECUTION. Это команда для проверки связи с ведомым.

### Ответы
Ответ на команду также представляет собой строку ASCII-символов возвращаемых параметров в формате 'AT\<COMMAND\>:\<PARAMS\>\r\n', затем статус 'OK\r\n'. Если ответ не предполагает возврата каких-либо параметров, то сразу возвращается статус 'OK\r\n'. Если возврат параметров невозможен (был получен некорректный запрос от MASTER) или сама команда от MASTER ошибочна, то сразу возвращается статус 'ERROR\r\n'.  
  
**ВНИМАНИЕ!** - далее, для упрощения, завершающая последовательность '\r\n' не показывается. Но она есть)  
  
Ниже приведён список команд настоящего протокола:
|№ |Command  |Supported types   |Description                                  |
|--|:-------:|------------------|:-------------------------------------------:|
|1 |''       |Execution         |Проверка связи                               |
|2 |'+CHECK' |Test, Read        |Проверка готовности MODULE к работе          |
|3 |'+LIST'  |Test, Read        |Чтение пар \<index-UUID\> доступных датчиков |
|4 |'+CFG'   |Test, Read, Write |Чтение/установка параметров датчиков         |
|5 |'+READ'  |Test, Write       |Одиночное чтение датчика                     |

Требования к формату параметров:
* Допустимые типы параметров - строка, целочисленное число, число с плавающей точкой;
* Числовые параметры с плавающей точкой используют в качестве разделителя между целочисленной и дробной частями точку, например: '3.14';
* Строковые параметры должны быть заключены в двойные кавычки, например: '3.14, "string", 9.8'.

Разберём подробнее структуру данных с параметрами датчика <sensor_params>. Она выглядит так: \<index\>,\<data_format\>,\<range_index\>,\<polling_period_ms\>.
* \<index\> - индекс датчика в числовом формате. Пример: '7'.
* <data_format> - формат данных для выходных данных датчика. Доступные на данный момент варианты:
    * "PLOTTER" - выходные данные в формате плоттера. О форматах данных написано ниже.
* <range_index> - индекс выбранного диапазона изменений в числовом формате согласно спецификации. Пример - '0'.
* <polling_period_ms> - период отправки значений датчика в непрерывном режиме. Формат - числовой, в миллисекундах. Пример - '500'.
  
Рассмотрим подробнее команды протокола:
1. Запрос наличия и работоспособности MODULE - классическая АТ-команда 'АТ'. MODULE должен ответить 'OK'.
2. **+SCFG** - параметры датчика(-ов) (Sensor ConFiGuration). Данная команда представлена в трёх типах: Test, Read и Set.
    * в варианте Test MODULE должен вернуть 'OK';
    * в варианте Read MODULE должен вернуть значения параметров всех датчиков, параметры каждого датчика группируются в квадратные скобки [], разделитель - '&', после следует 'OK';
    * в варианте Set значения параметров присваиваются конкретному датчику по UUID и имени и MODULE отвечает 'ОК' (если такое имя и/или UUID датчика найдены) или параметры игнорируются и MODULE отвечает 'ERROR' (если имя и/или UUID не найдены). 
3. **+PAS** - значения параметров текущего активного датчика (Parameters of Active Sensor). Данная команда представлена в двух типах: Test и Read.
    * в варианте Test MODULE должен вернуть 'OK';
    * в варианте Read MODULE должен ответить в формате 'AT+PAS:<sensor_params>' и 'OK' если датчик активен, или 'AT+PAS=\<"NONE"\>' и 'OK', если активных датчиков нет.
4. **+SGAS** - однократный запрос значений активного датчика (Single Get from Active Sensor). Данная команда представлена в двух типах: Test и Execution.
    * в варианте Test MODULE должен вернуть 'OK';
    * в варианте Execution MODULE должен однократно вернуть 'OK' и данные датчика в специфическом data-формате, определённом в конфигурации датчика.
5. **+SPAS** - старт непрерывного опроса активного датчика (Start Polling of Active Sensor). Данная команда представлена в двух типах: Test и Execution.
    * в варианте Test MODULE должен вернуть 'OK';
    * в варианте Execution MODULE должен однократно вернуть 'OK' и начать бесконечную передачу данных активного датчика в специфическом data-формате в соответствии с установленным в конфигурации периодом опроса. Передача происходит до отмены этого режима или до перевода датчика в состояние 'OFF'.
6. **+BPAS** - отмена непрерывного опроса активного датчика (Break Polling of Active Sensor). Данная команда представлена в двух типах: Test и Execution.
    * в варианте Test MODULE должен вернуть 'OK';
    * в варианте Execution MODULE должен остановить опрос датчика и вернуть 'OK'.
***
## Протокол данных
На данный момент поддерживаются следующие протоколы кодирования данных:
* "PLOTTER" - данный формат передаёт значения с плавающей точкой и индекс канала в виде ASCII-символов. Сообщение выглядит следующим образом - '$value_index;\r\n' для одноканального датчика (пример - '$3.14_0;\r\n')  и '$value1_index1 value2_index2 value3_index3 .... valueN_indexN;\r\n' для многоканального датчика (пример - '$3.14_0 2.22_1 5.55_2;\r\n'.
***
## О управлении потоком RTS/CTS
Настоящий протокол предполагает управление потоком со стороны MASTER. Это необходимо для того, чтобы можно было прервать передачу данных в режиме непрерывного опроса датчика. Таким образом, на стороне MASTER есть только выход RTS (ready to send), на стороне MODULE есть только вход CTS (clear to send).  
**ВАЖНО** - получив сигнал на прерывание передачи, MODULE должен очистить свой выходной буфер, чтобы его дальнейшие ответы не слились с данными
***
Типичный порядок работы с датчиком:
<p align="center">
  <img src="/diagrams/protocol-flow.png">
</p>
