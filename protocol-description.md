# Настоящий документ описывает протокол взаимодействия между головным устройством (далее - MASTER) и модулем расширения (далее - EXT_MODULE) от внешних разработчиков.

## MASTER - устройство, обеспечивающее взаимодействие с приложением по Bluethooth и считывание данных с датчиков, а также фильтрацию и калибровку данных
## EXT_MODULE - устройство, обеспечивающее работу с реальным физическим датчиком и нормирование сырых данных к значениям физической величины

* количество датчиков в рамках одного EXT_MODULE - от 1 и выше;
* количество каналов в рамках одного датчика - от 1 и выше;
* физический интерфейс для подключения EXT_MODULE к MASTER - UART в дуплексном режиме, скорость 115200;
* протокол команд - АТ;
* протокол данных - строковый протокол плоттера.

MASTER общается с EXT_MODULE посредством AT-команд. Рассмотрим более подробно синтаксис АТ-команд:
АТ-команда представляет собой строку ASCII-символов в формате 'AT<COMMAND><SUFFIX><DATA>\r\n'. В начале всегда идёт префикс 'AT',
затем команда, далее - суффикс, определяющий тип команды, после - данные, в самом конце - завершающая последовательность '\r\n'.
Ответ на команду также представляет собой строку ASCII-символов возвращаемых данных в формате 'AT<COMMAND>:<DATA>\r\n', затем статус 'OK' или 'ERROR', также с '\r\n'.
В некоторых случаях, если данные возвращать не требуется, то возвращается только статус.
***
В широком смысле, AT-команды можно разделить на два формата: **Basic Commands** и **Extended Commands**.
* Basic Commands -эти команды не начинаются с '+'. Пример: 'ATCFG'. 
* Extended commands - эти команды начинаются с '+'. Пример: 'AT+CFG'.
В настоящем протоколе все команды в формате Extended для упрощения парсинга.
***
Кроме того, все АТ-команды делятся на 4 типа - **Test Commands**, **Read Commands**, **Set Commands** и **Execution Commands**.
Тип определяется суффиксом, согласно следующей таблице:
|Type      |Suffix | Назначение                               |
|----------|:-----:|------------------------------------------|
|Test      |=?     |Проверка поддержки ведомым данной команды |
|Read      |?      |Получение от ведомого настроек            |
|Set       |=      |Установка на ведомом настроек             |
|Execution |       |Запуск определённого действия             |

Ведомый отвечает на каждую команду данными (если они требуются) и статусом
## Test Commands
Эти команды позволяют узнать, поддерживает ли ведомый данную команду или нет. Синтаксис: 'AT<COMMAND_NAME>=?'.
Ведомый должен ответить 'OK' или, если команда не поддерживается, 'ERROR'.
Пример: 'AT+CFG=?' -> 'OK'.
## Read Commands
Эти команды служат для получения информации от ведомого. Синтаксис: 'AT<COMMAND_NAME>?'.
Ведомый должен вернуть список значений параметров и 'OK' или, если команда не поддерживается, сразу 'ERROR'.
Пример: 'AT+CFG?' -> 'AT+CFG:0,"OFF",11' 'OK'.
## Set Commands
Эти команды служат для установки настроек на ведомом. Синтаксис: 'AT<COMMAND_NAME>=<val1>,<val2>,...,<valN>'.
Ведомый должен ответить 'OK' в случае успешного применения настроек или 'ERROR' в случае ошибки.
Пример: 'AT+CFG=1,"ON",9' -> 'OK'.
## Execution Commands
Эти команды управляют работой ведомого. Синтаксис: 'AT<COMMAND_NAME>'.
Ведомый должен ответить 'OK' в случае успешного выполнения команды или 'ERROR' в случае ошибки.
Пример: 'AT+CFG' -> 'OK'.
***
Особняком стоит специализированная команда в формате 'AT'. Это команда для проверки связи с ведомым, ответ на неё должен быть 'OK'.
***
Ниже приведён список команд настоящего протокола и ожидаемые ответы:
|№  |Request from MASTER       |Command type |Response from EXT_MODULE                                       |
|---|:------------------------:|-------------|:-------------------------------------------------------------:|
|1  |'AT'                      |Check        |'OK'                                                           |
|2.1|'AT+SCFG=?'               |Test         |'OK'                                                           |
|2.2|'AT+SCFG?'                |Read         |'AT+SCFG:[<sensor_params>]&[...]' 'OK'                         |
|2.3|'AT+SCFG=<sensor_params>' |Set          |'OK' or 'ERROR'                                                |
|3.1|'AT+PAS=?'                |Test         |'OK'                                                           |  
|3.2|'AT+PAS?'                 |Read         |'AT+PAS:<sensor_params>' 'OK' or 'AT+SCFG:"NONE"' 'OK'         |
|4.1|'AT+SGAS=?                |Test         |'OK'                                                           |  
|4.2|'AT+SGAS'                 |Execution    |\<value(-s) in data format\>                                   |
|5.1|'AT+SPAS=?'               |Test         |'OK'                                                           |
|5.1|'AT+SPAS'                 |Execution    |\<value(-s) in data format\> \<value(-s) in data format\> ...  |
|6.1|'AT+BPAS=?'               |Test         |'OK'                                                           |
|6.1|'AT+BPAS'                 |Execution    |'OK'                                                           |

Требования к формату команд и ответов:
* Допустимые типы данных в параметрах - строка, целочисленное число, число с плавающей точкой.
* Числовые параметры с плавающей точкой используют в качестве разделителя между целочисленной и дробной частями точку, например: '3.14'
* Строковые параметры должны быть заключены в двойные кавычки, например: '3.14, "string", 9.8'.

Разберём подробнее структуру данных с параметрами датчика <sensor_params>. Она выглядит так: <uuid>,<state>,<data_format>,<range_index>,<polling_period>.
    * \<uuid\> - стандартный UUID датчика в строковом формате "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx".  
    * \<state\> - состояние датчика. Доступны следующие состояния:
        * "OFF" - датчик не активен. Это состояние всех датчиков по умолчанию.
        * "ON" - датчик активен. Только **ОДИН** датчик может быть активен в текущий момент. Текущий активированный датчик автоматически выключается при включении следующего.
    * <data_format> - формат данных для выходных значений датчика. Доступные варианты:
        * "PLOTTER" - выходные данные в строковом формате плоттера: '$float_value index;', например - '$49.5 0;'
    * <range_index> - индекс выбранного диапазона изменений согласно спецификации. Формат - "integer", например - "0".
    * <polling_period> - период отправки значений датчика в непрерывном режиме. Задаётся в миллисекундах в формате "integer", например - "500".
  
Рассмотрим подробнее:
1. Запрос наличия и работоспособности EXT_MODUTE - классическая АТ-команда "АТ". EXT_MODULE должен ответить "OK".
2. **+SCFG** - параметры датчика(-ов) (Sensor ConFiGuration). Данная команда представлена в трёх типах: Test, Read и Set. В варианте Read EXT_MODULE должен вернуть значения параметров всех датчиков, параметры каждого датчика группируются в квадратные скобки [], разделитель - '&'. В варианте Set значения параметров присваиваются конкретному датчику по UUID. 
3. **+PAS** - значения параметров текущего активного датчика (Parameters of Active Sensor). Данная команда представлена в двух типах: Test и Read. В варианте Read EXT_MODULE должен ответить в формате 'AT+PAS:<sensor_params>' если датчик активен, или "AT+PAS=\<"NONE"\>", если активных датчиков нет.
4. **+SGAS** - однократный запрос значений активного датчика (Single Get from Active Sensor). Данная команда представлена в двух типах: Test и Execution. В варианте Execution EXT_MODULE должен однократно передать значение(-я) датчика в специфическом data-формате, определённом в конфигурации датчика.
5. **+SPAS** - старт непрерывного опроса активного датчика (Start Polling of Active Sensor). Данная команда представлена в двух типах: Test и Execution. В варианте Execution EXT_MODULE должен начать передачу значения(-ий) датчика в специфическом data-формате в соответствии с установленным в конфигурации периодом опроса.
6. **+BPAS** - остановка непрерывного опроса активного датчика (Break Polling of Active Sensor). Данная команда представлена в двух типах: Test и Execution. В варианте Execution EXT_MODULE должен остановить опрос датчика и ответить "OK".
***
Типичный порядок работы с датчиком:
   
