# Настоящий документ предназначен для внешних разработчиков и описывает процесс разработки устройста, совместимого с проектом "Школьная лаборатория"
***
## [Соглашение о терминах](/terms-convention.md)
***
## Содержание
* [Цель документа](#цель-документа)
* [Общее описание мультисенсора](#общее-описание-мультисенсора)
* [Характеристики мультисенсора](#характеристики-мультисенсора)
* [Этапы разработки](#этапы-разработки)
* [Этап 1: определиться с датчиками и их характеристиками, составить спецификации](#этап-1-определиться-с-датчиками-и-их-характеристиками-составить-спецификации)
* [Этап 2: разработка схемотехники](#этап-2-разработка-схемотехники)
* [Этап 3: программирование центрального микроконтроллера блока MASTER](#этап-3-программирование-центрального-микроконтроллера-блока-master)
* [Этап 4: тестирование](#этап-4-тестирование)
***
## Цель документа
Целью данного документа является предоставление внешнему разработчику алгоритма действий, по которому можно разработать новый мультисенсор и добавить этот мультисенсор в главное приложение  
[К содержанию](#содержание)
***
## Общее описание мультисенсора
Мультисенсор устроен следующим образом:  
<p align="center">
  <img src="/related-documents/diagrams/device-block-diagram.png">
</p>

Мультисенсор состоит из двух блоков: блок MASTER и блок SENSORS. Внешний разработчик разрабатывает блок SENSORS, далее добавляет к нему уже готовую схемотехнику блока MASTER и получает готовое устройство. Задача блок SENSORS - работа с физическими датчиками S и передача их значений блоку MASTER посредством [протокола](/protocol-description.md). Всю работу по "общению" с приложением выполняет блок MASTER.  
  
[К содержанию](#содержание)
***
## Характеристики мультисенсора
* количество физических датчиков у блока SENSORS - от 1 и выше;
* количество каналов измерения в рамках одного физического датчика - от 1 и выше (например, акселерометр - трёхканальный);
* физический интерфейс для подключения блока SENSORS к блоку MASTER - UART в дуплексном режиме, скорость 115200, 8n1.  
  
[К содержанию](#содержание)
***
## Этапы разработки
***
## Этап 1: определиться с датчиками и их характеристиками, составить спецификации
На этом этапе необходимо составить таблицы с характеристиками для каждого датчика, применяемого в новом мультисенсоре. Датчики могут быть:
* с одной осью Y и одним каналом измерения - тип 1;
* с одной осью Y и несколькими каналами измерения - тип 2;
* с несколькими осями Y и одним каналом измерения  - тип 3;
* с несколькими осями Y и несколькими каналами измерения - тип 4.  
На данном этапе для внешних разработчиков доступны только тип 1 и тип 2.  
  
Таблицы в формате markdown присылаются нам в виде PullRequest по [адресу](/sensor-parameter-tables), после чего проверяются инженером и, в случае отсутствия проблем, PullRequest принимается и содержимое таблиц появляется в данном репозитории. Именование таблиц - первые восемь символов UUID-а и слово 'spec' через точку.  
> Пример: 'ba575001.spec.md'  

Далее необходимо на основе этих таблиц составить json-спецификации. За основу следует брать [json-схему](/specifications/schema/sensor.schema.json). Спецификации такж присылаются нам в виде PullRequest по [адресу](/specifications). Именование спецификаций - первые восемь символов UUID-а и слово 'spec' через точку.  

> Пример: 'ba575001.spec.json'  

Общая структура конфигурационного файла выглядит так (красным отмечено то, что заполняет внешний разработчик):  
<p align="center">
  <img src="/related-documents/diagrams/config-file-structure.png">
</p>
  
Следует обратить внимание, что **ВАЖНОЕ** значение имеет порядок следования диапазонов датчика (на предыдущей схеме обозначены зелёным) - этот порядок является индексом при обращении блока MASTER к конкретному диапазону датчика. На примере ниже это показано. Блок MASTER при работе с датчиком из примера будет оперировать двумя индексами: "0" для -100...1000 и "1" для -40...360.
<p align="center">
  <img src="/related-documents/pictures/spec-range-index.png">
</p>
  
**Пример для типа 1 - датчик температуры**

| Параметр                                 | Значение                             | 
|------------------------------------------|--------------------------------------|
| Название датчика                         | Температура (ЩУП)                    |
| UUID датчика                             | ba575001-eca0-11ec-8ea0-1337ac062022 |
| Количество осей по Y                     | 1                                    |
| Единицы измерения для оси Y              | °C                                   |
| Заголовок оси Y                          | Температура                          |
| Количество диапазонов измерения по оси Y | 2                                    |
| Диапазон 1: минимальное значение         | -100                                 |
| Диапазон 1: максимальное значение        | 1000                                 |
| Диапазон 2: минимальное значение         | -40                                  |
| Диапазон 2: максимальное значение        | 360                                  |
| Количество каналов измерения             | 1                                    |

```json
{
  "$schema": "schema/sensor.schema.json",
  "uuid": "ba575001-eca0-11ec-8ea0-1337ac062022",
  "description": "Температура (термопара)",
  "info": {
    "title": "Температура (ЩУП)",
    "sortOrder": -1
  },
  "yAxis": [
    {
      "unit": "°C",
      "title": "Температура",
      "range": {
        "list": [
          {
            "min": -100.0,
            "max": 1000.0,
            "precision": 1,
            "factor": "NORMAL",
            "calibrationPointsMin": 2
          },
          {
            "min": -40.0,
            "max": 360.0,
            "precision": 1,
            "factor": "NORMAL",
            "calibrationPointsMin": 0
          }
        ],
        "defaultIndex": 0
      }
    }
  ],
  "value": [
    {
      "title": "Термопара",
      "options": [
        "chart",
        "gauge",
        "current",
        "measurements"
      ],
      "yAxisIndex": 0
    }
  ]
}
```
  
[К содержанию](#содержание)
***
## Этап 2: разработка схемотехники
Внешний разработчик производит разработку схемотехники, взяв за основу [референс](/circuit-design-requirements.md). На данном этапе можно написать программу для периферийного микроконтроллера и предварительно отладить блок SENSORS. Наш инженер в это время добавляет новые сенсоры в FIRMWARE и в CLIENT_APP, формирует новый релиз UPDATER_APP, тестирует систему с имитацией блока SENSORS

[К содержанию](#содержание)
***
## Этап 3: программирование центрального микроконтроллера блока MASTER
На данном этапе внешний разработчик получает от нас UPDATER_APP и с его помощью программирует ESP32 блока MASTER. Интерфейс UPDATER_APP выглядит следующим образом:  
<p align="center">
  <img src="/related-documents/pictures/updater-start-page-edited.png">
</p>  

Необходимо подключить ESP32 к компьютеру, затем в выпадающем списке (1) выбираем COM-порт, на котором определился программатор. В выпадающем списке (2) выбираем код платы, в выпадающем списке (3) должен остаться только один тип мультисенсора - тот, который мы сейчас программируем. После этого нажимаем кнопку (4) и наблюдаем за прогрессом в логе (5). Процесс прошивки должен закончиться либо сообщением зелёного цвета "ТЕСТИРОВАНИЕ ПРОШЛО УСПЕШНО", либо сообщением красного цвета "ТЕСТИРОВАНИЕ ПРОВАЛЕНО". В последнем случае необходимо связаться с нами для решения проблемы  

[К содержанию](#содержание)
***
## Этап 4: тестирование
В случае успешного выполнения предыдущего пункта, запустить программу CLIENT_APP - либо приложение, либо [веб-версию](https://school-lab.bast.ru). Стартовое окно выглядит так:  
<p align="center">
  <img src="/related-documents/pictures/client-start-page-edited.png">
</p>  
  
Выбрать в выпадающем списке (1) нужный тип мультисенсора и подключиться (2) к нему. После чего провести проверку работоспособности мультисенсора со всеми датчиками на всех диапазонах  
  
[К содержанию](#содержание)
***
